<html>
<meta charset="UTF-8">
<body>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css"
	  integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://canvasjs.com/assets/script/jquery.canvasjs.min.js"></script>

<script>
    function getFormDataInJson(dataList) {
        let map = {};
        $.map(dataList, function (n) {
            map[n['name']] = n['value'];
        });

        return map;
    }

    function convertToChartData(objectList, from, to) {
        $.map(objectList, function (obj) {
            obj[to] = obj[from]
        });
        return objectList;
    }

    window.onload = function () {
        let $stats = $("#stats");
        let $main = $("#main");
        let $mainBlock = $("#main-block");
        let $statsBlock = $("#stats-block");

        //render stats
        $stats.click(function (e) {
            e.preventDefault();

            $mainBlock.hide();
            $main.removeClass("active");

            $statsBlock.show();
            $stats.addClass("active");
        });

        //render main page
        $main.click(function (e) {
            e.preventDefault();

            $statsBlock.hide();
            $stats.removeClass("active");

            $mainBlock.show();
            $main.addClass("active");
        });

        $("#stats-form").submit(function (e) {
            e.preventDefault();
            let drawChart = function (dataPoints) {
                let options = {
                    theme: "light2",
                    exportEnabled: true,
                    animationEnabled: true,
                    data: [{
                        type: "pie",
                        startAngle: 40,
                        toolTipContent: "<b>{label}</b>: {y}",
                        showInLegend: "true",
                        legendText: "{label}",
                        indexLabelFontSize: 16,
                        indexLabel: "{label} - {y}",
                        dataPoints: dataPoints
                    }]
                };

                $("#chartContainer").show();
                let chart = new CanvasJS.Chart("chartContainer", options);
                chart.render()
            };

            $.ajax({
                url: "/stats",
                method: "post",
                data: JSON.stringify(getFormDataInJson($(this).serializeArray())),
                success: function (resp) {
                    resp = convertToChartData(resp, "count", "y");
                    resp = convertToChartData(resp, "city", "label");
                    drawChart(resp);
                },
                fail: function () {
                    location.reload()
                }
            });
        });

        $("#main-form").submit(function (e) {
            e.preventDefault();
            let data = getFormDataInJson($(this).serializeArray());
            if (!data.external_url.includes("http://") && !data.external_url.includes("https://")) {
                data.external_url = 'http://' + data.external_url;
            }

            $.ajax({
                url: "/creation",
                method: "post",
                contentType: 'application/json;charset=UTF-8',
                data: JSON.stringify(data),
                success: function (resp) {
                    let r = JSON.parse(resp);
                    if (r.code !== 0) {
                        alert(r.text);
                        return;
                    }
                    //TODO green bubble with response text
                    alert(r.text);
                },
                fail: function () {
                    location.reload()
                },
            });
        });
    };
</script>

<div class="card text-center">
	<div class="card-header">
		<ul class="nav nav-tabs card-header-tabs">
			<li class="nav-item">
				<a class="nav-link active" id="main" href="#">Констуктор</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" id="stats" href="#">Статистика</a>
			</li>
		</ul>
	</div>
	<div class="card-body text-center" id="main-block" style="display: inline">
		<h5 class="card-title">Куда будем перенаправлять?</h5>
		<div class="d-flex justify-content-center">
			<form class="form-inline" id="main-form">
				<div class="form-group input-group mx-sm-3 mb-2">
					<div class="input-group-prepend">
						<div class="input-group-text">http://</div>
					</div>
					<input type="text" class="form-control" id="external_url" name="external_url"
						   placeholder="Твой url" required>
				</div>
				<button type="submit" id="submit_form" class="btn btn-primary mb-2">Создать</button>
			</form>
		</div>
	</div>
	<div class="card-body text-center" id="stats-block" style="display: none">
		<h5 class="card-title">Статистика посещений</h5>
		<div class="d-flex justify-content-center">
			<form class="form-inline" id="stats-form">
				<div class="form-group input-group mx-sm-3 mb-2">
					<input type="text" class="form-control" name="token" id="token"
						   placeholder="Поиск по токену" required>
					<div class="input-group-append">
						<button type="submit" class="input-group-text btn btn-primary">Поиск</button>
					</div>
				</div>
			</form>
		</div>
		<div id="chartContainer" style="height: 300px; width: 100%; display: none"></div>
		<div id="fullTable"></div>
	</div>
</div>
</body>
</html>
